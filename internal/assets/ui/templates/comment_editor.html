{{template "base" .}}

{{ define "content" }}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<div class="content-header animate-fade-in">
    <div class="header-left">
        <a href="/dashboard" class="btn btn-muted btn-sm" style="margin-right: 1rem;"><i
                class="fas fa-arrow-left"></i></a>
        <div>
            <h1 class="text-accent">{{ .Filename }}</h1>
            <p class="text-muted">{{T .Lang `comment_editor_description` }}</p>
        </div>
    </div>
</div>

<div class="comment-editor-layout animate-slide-up">
    <!-- Sidebar: Slide List -->
    <div class="slide-sidebar scrollbar-thin">
        <div class="sidebar-header p-3 border-bottom border-muted">
            <input type="text" id="slide-search" class="form-control form-control-sm bg-dark text-light border-muted"
                placeholder="Search slides..." onkeyup="filterSlides()">
        </div>
        <div class="slide-list mt-2">
            {{ range .SlideNums }}
            {{ $slide := index $.Slides . }}
            <div class="slide-nav-item animate-fade-in" data-slide="{{ . }}"
                hx-get="/editor/comments?fileID={{ $.FileID }}&slide={{ . }}" hx-target="#editor-detail-pane"
                hx-push-url="true" onclick="setActiveSlide(this)">
                <div class="nav-thumb">
                    <img src="/thumbnails/{{ stripExt $.Filename }}/slide-{{ printf " %04d" . }}.png"
                        onerror="this.src='/static/images/slide-placeholder.png'; this.onerror=null;">
                </div>
                <div class="nav-info">
                    <span class="slide-num">Slide {{ . }}</span>
                    <span
                        class="comment-count badge {{ if $slide.Comments }}bg-accent text-dark{{ else }}bg-muted{{ end }}">
                        {{ len $slide.Comments }}
                    </span>
                </div>
            </div>
            {{ end }}
        </div>
    </div>

    <!-- Main Detail Pane -->
    <div class="editor-detail-pane scrollbar-thin" id="editor-detail-pane">
        <div class="welcome-pane text-center animate-fade-in py-5">
            <i class="fas fa-edit fa-4x text-muted opacity-2 mb-4"></i>
            <h3 class="text-muted">Select a slide to edit comments</h3>
            <p class="text-muted small">Choose from the sidebar to begin customizing slide content.</p>
        </div>
    </div>
</div>

<script>
    function setActiveSlide(el) {
        document.querySelectorAll('.slide-nav-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');
    }

    function filterSlides() {
        const query = document.getElementById('slide-search').value.toLowerCase();
        document.querySelectorAll('.slide-nav-item').forEach(item => {
            const text = item.innerText.toLowerCase();
            item.style.display = text.includes(query) ? 'flex' : 'none';
        });
    }

    // Auto-load first slide if none selected
    window.addEventListener('load', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.has('slide')) {
            const slideNum = params.get('slide');
            const item = document.querySelector(`.slide-nav-item[data-slide="${slideNum}"]`);
            if (item) item.click();
        }
    });

    // Handle HTMX after-swap to re-initialize editor if needed (though baked into partial)
    document.body.addEventListener('htmx:afterSwap', (evt) => {
        if (evt.detail.target.id === 'editor-detail-pane') {
            // Any post-swap logic if needed
        }
    });
</script>

<style>
    .comment-editor-layout {
        display: flex;
        height: calc(100vh - 180px);
        gap: 1.5rem;
        background: rgba(var(--bg-rgb), 0.5);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid var(--border);
    }

    .slide-sidebar {
        width: 300px;
        flex-shrink: 0;
        background: rgba(0, 0, 0, 0.2);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
    }

    .slide-list {
        overflow-y: auto;
        flex-grow: 1;
    }

    .slide-nav-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }

    .slide-nav-item:hover {
        background: rgba(var(--accent-rgb), 0.05);
    }

    .slide-nav-item.active {
        background: rgba(var(--accent-rgb), 0.1);
        border-left-color: var(--accent);
    }

    .nav-thumb {
        width: 80px;
        height: 45px;
        overflow: hidden;
        border-radius: 4px;
        border: 1px solid var(--border);
    }

    .nav-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .nav-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .slide-num {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .comment-count {
        font-size: 0.7rem;
        align-self: flex-start;
    }

    .editor-detail-pane {
        flex-grow: 1;
        padding: 2rem;
        overflow-y: auto;
        position: relative;
    }

    .opacity-2 {
        opacity: 0.2;
    }
</style>
{{ end }}