{{template "base" .}}

{{ define "content" }}
{{ if .pptxSummary }}
<div class="card mb-4"
    style="background: var(--glass-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--accent);">
    <h4 style="color: var(--accent);"><i class="fas fa-file-alt"></i> Presentation Summary</h4>
    <p style="margin-top: 0.5rem; font-size: 0.95rem; line-height: 1.5;">{{ .pptxSummary }}</p>
</div>
{{ end }}

<h3>Select Slides for Collection</h3>
<div class="pptx-grid" id="slide-selection-grid">
    <!-- Slides will be loaded here -->
    {{ range .slides }}
    <div class="pptx-card slide-card"
        onclick="$(this).toggleClass('selected'); $(this).find('input').prop('checked', $(this).hasClass('selected'))">
        <input type="checkbox" name="selectedSlides" value="{{ .SlideNum }}" style="display: none;">
        <div class="thumbnail">
            <img src="/{{ .PNGPath }}" alt="Slide {{ .SlideNum }}">
            <div class="selection-indicator">
                <i class="fas fa-check-circle"></i>
            </div>
            {{ if .Comments }}
            <div class="comment-marker">
                <i class="fas fa-comment"></i>
                <div class="comment-popover">
                    <div class="popover-header"><i class="fas fa-comments"></i> Slide Comments</div>
                    <div class="popover-body">{{ .Comments }}</div>
                </div>
            </div>
            {{ end }}
        </div>
        <div class="card-info">
            <div class="card-title">{{ .Title }}</div>
            {{ if .AISummary }}
            <div class="card-summary"
                style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                {{ .AISummary }}
            </div>
            {{ end }}
        </div>
    </div>
    {{ end }}
</div>

<div id="ai-results"
    style="margin-top: 2rem; padding: 1rem; background: var(--card-bg); border-radius: 12px; display: none; border: 1px solid var(--primary);">
    <h4 style="color: var(--primary); margin-bottom: 0.5rem;"><i class="fas fa-bolt"></i> AI Insights</h4>
    <div id="ai-content"></div>
</div>

<style>
    .slide-card {
        cursor: pointer;
        position: relative;
    }

    .slide-card.selected {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
    }

    .selection-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.5rem;
        color: var(--primary);
        display: none;
    }

    .slide-card.selected .selection-indicator {
        display: block;
    }

    .comment-marker {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: var(--accent);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .comment-popover {
        position: absolute;
        bottom: 40px;
        right: 0;
        width: 250px;
        background: var(--card-bg);
        border: 1px solid var(--accent);
        border-radius: 8px;
        padding: 0;
        display: none;
        z-index: 100;
        box-shadow: var(--shadow);
        cursor: default;
    }

    .comment-marker:hover .comment-popover {
        display: block;
    }

    .popover-header {
        background: var(--accent);
        color: white;
        padding: 6px 12px;
        font-size: 0.75rem;
        font-weight: 700;
        border-radius: 7px 7px 0 0;
    }

    .popover-body {
        padding: 10px;
        font-size: 0.8rem;
        color: var(--text-color);
        max-height: 150px;
        overflow-y: auto;
        white-space: pre-wrap;
    }
</style>

<div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
    <input type="hidden" name="fileID" value="{{ .FileID }}">
    <button class="btn" style="background: var(--card-bg);" onclick="window.location='/dashboard'">Cancel</button>
    <button class="btn" style="background: var(--glass-bg); color: var(--accent); border: 1px solid var(--accent);"
        hx-post="/analyze" hx-include="[name='fileID'], [name='selectedSlides']" hx-target="#ai-content"
        onclick="$('#ai-results').show(); $('#ai-content').html('Analyzing selected slides...')">
        <i class="fas fa-bolt"></i> AI Analyze
    </button>
    <button class="btn btn-primary" hx-post="/collect" hx-include="[name='fileID'], [name='selectedSlides']">
        <i class="fas fa-plus"></i> Add to Collection
    </button>
</div>
{{ end }}